<div ng-controller="ChatController as vm" ng-init="vm.init()">
    <header class="header">
      <div class="container">
        <div class="header__content">
          <a ui-sref="conversations" class="back-button">
            <span class="back-icon">â†</span>
            <span>Back to Conversations</span>
          </a>
          <h2 class="chat-title">{{vm.chatHeader}}</h2>
        </div>
      </div>
    </header>
    
    <main class="chat container">
      <h1 id="chatHeader">{{vm.chatHeader}}</h1>
    
      <div class="messages-container">
        <div ng-if="vm.loading" class="loading-indicator">
          Loading messages...
        </div>
        
        <div ng-if="!vm.loading && vm.messages.length === 0" class="no-messages">
          No messages yet. Start the conversation!
        </div>
    
        <div class="message" 
             ng-repeat="msg in vm.messages track by msg.message_id"
             ng-class="{'sent': msg.sender_id === vm.currentUser.user_id, 'received': msg.sender_id !== vm.currentUser.user_id}">
          <p class="message-content">{{msg.content}}</p>
          <div ng-if="msg.attachment_url">
            <img ng-src="{{msg.attachment_url}}" alt="Attached image" class="message-attachment">
          </div>
          <div class="message-timestamp">
            {{msg.timestamp | date:'dd/MM HH:mm'}}
          </div>
        </div>
      </div>
    
      <div class="chat-input-container">
        <!-- Attachment preview -->
        <div class="attachment-preview" ng-if="vm.attachmentFile">
          <div class="preview-content">
            <img ng-src="{{vm.attachmentFile | filePreview}}" alt="Preview" class="preview-image">
            <span class="file-name">{{vm.attachmentFile.name}}</span>
          </div>
          <button ng-click="vm.removeAttachment()" class="remove-attachment" aria-label="Remove attachment">Ã—</button>
        </div>
    
        <div class="chat-input-wrapper">
          <textarea 
            ng-model="vm.newMessage" 
            placeholder="Type a message..." 
            ng-keypress="$event.keyCode === 13 && !$event.shiftKey && vm.send()"
            rows="1"
            auto-resize
            class="message-input"
          ></textarea>
          
          <div class="chat-actions">
            <input type="file" 
                   id="attachmentInput" 
                   style="display: none" 
                   accept="image/*"
                   onchange="angular.element(this).scope().vm.handleFileSelect(this.files)">
            
            <button class="action-btn attach-btn" onclick="document.getElementById('attachmentInput').click()">
              <span class="icon">ğŸ“</span>
            </button>
            
            <button class="action-btn send-btn" ng-click="vm.send()" ng-disabled="!vm.newMessage && !vm.attachmentFile">
              Send
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>
  